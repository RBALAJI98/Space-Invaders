// *************************** Images ***************************





// enemy ship that starts at the top of the screen (arms/mouth closed)
// width=16 x height=10





const unsigned short SmallEnemy10pointA[] = {
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
};

// enemy ship that starts at the top of the screen (arms/mouth open)
// width=16 x height=10
const unsigned short SmallEnemy10pointB[] = {
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
};

// enemy ship that starts in the middle of the screen (arms together)
// width=16 x height=10
const unsigned short SmallEnemy20pointA[] = {
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000,
	
}



// *************************** Capture image dimensions out of BMP**********

#include <stdint.h>
#include "tm4c123gh6pm.h"
#include "ST7735.h"
#include "Random.h"
#include "TExaS.h"
#include "ADC.h"
#include "SysTick.h"
#include "Timer0.h"
#include "Port_Interrupt.h"
#include "sound.h"
#include "DAC.h"
#include "UART.h"
#include "Fifo.h"



#define fresh 1
#define stale 0

#define small 0



void DisableInterrupts(void); // Disable interrupts
void EnableInterrupts(void);  // Enable interrupts
void Delay100ms(uint32_t count); // time delay in 0.1 seconds
void Start_Screen(void);
void  WaitForInterrupt(void);
int32_t Convert(uint32_t);
void LCD_FPS(void);
void Enemy_Movement(void);
void StartCritical(void);
void EndCritical(void);
void StartScreen(void);
void GPIOPortC_Handler(void);
void Increase_Level(void);
void Life_lost(void);
void End_Screen(void);
void Enemy_Fire(void);
void Multi_Player(void);
uint32_t Convert_Multi(uint32_t input);
void Multiplayer_Movement(void);
void End_Screen_Multi(void);



//**********************************************************************************//
//Global Variables//
uint32_t gamestatus;
uint32_t ADCmail;
uint32_t ADCstatus;
uint8_t i,j,k,l,m,n,o,f;
int32_t num_missile;
int32_t num_aliens = 12;
uint8_t timer_flag,enemy_flag;
uint8_t level = 15;
uint16_t enemy_firing = 110;
uint8_t firing_flag;

uint8_t fpsflag;
uint32_t total_missile;
uint32_t total_enemy_missile;
uint8_t lose_life;
uint8_t increase_level;
uint32_t sum;
uint8_t first_flag;
uint8_t start_flag;




struct player{
	int32_t x,y;
	uint8_t lives;
	uint8_t score;
};

typedef struct player player;
 player player1;

struct playertwo{
	uint32_t x,y;
	uint8_t lives;
	uint8_t score;
	
	
};

typedef struct playertwo playertwo;
playertwo player2; 



struct Enemy{
	int32_t x,y;
	uint8_t point;
	//uint8_t size;
};

typedef struct Enemy Enemy;
Enemy Enemy1[12];

struct Missile{
	int32_t x,y;
	
	
};
typedef struct Missile Missle;
Missle Missile1[150];

struct Enemy_Missile{
	int32_t x,y;
};

typedef struct Enemy_Missile Enemy_Missile;
Enemy_Missile Enemy_Missile1[150];


//*******************//



int main(void){
  TExaS_Init();  // set system clock to 80 MHz
  Random_Init(1);
	Output_Init();
	DisableInterrupts();
	UART_Init();
	
	//StartScreen();
	//Delay100ms(20); 
	//DAC_Init();
	Sound_Init();
	ADC_Init();  
	Systick_Init();
	EdgeCounter_Init();
	

  
	//Multi_Player();
	StartScreen();
  ST7735_FillScreen(0x0000);            // set screen to black
	
	
	
	
  
  ST7735_DrawBitmap(52, 159, PlayerShip0, 34,7); // player ship middle bottom
	player1.x = 52;
	player1.y = 159;
	player1.lives = 4;
	player1.score = 0;
	
	
  //ST7735_DrawBitmap(53, 151, Bunker0, 18,5);

	//ST7735_DrawBitmap(52, 150, missile, 4,13);
	//Missile1[0].x = 52;
	//Missile1[0].y = 150;
	
	
	
  ST7735_DrawBitmap(0, 40, SmallEnemy10pointA, 16,10);
	Enemy1[0].x = 0;
	Enemy1[0].y = 40;
	ST7735_DrawBitmap(20,40, SmallEnemy10pointB, 16,10);
	Enemy1[1].x = 20;
	Enemy1[1].y = 40;
	ST7735_DrawBitmap(40, 40, SmallEnemy20pointA, 16,10);
	Enemy1[2].x = 40;
	Enemy1[2].y = 40;
	ST7735_DrawBitmap(60, 40, SmallEnemy20pointB, 16,10);
	Enemy1[3].x = 60;
	Enemy1[3].y = 40;
	ST7735_DrawBitmap(80, 40, SmallEnemy30pointA, 16,10);
	Enemy1[4].x = 80;
	Enemy1[4].y = 40;
  ST7735_DrawBitmap(100, 40, SmallEnemy30pointB, 16,10);
	Enemy1[5].x = 100;
	Enemy1[5].y = 40;
	ST7735_DrawBitmap(0, 60, SmallEnemy10pointA, 16,10);
	Enemy1[6].x = 0;
	Enemy1[6].y = 60;
	ST7735_DrawBitmap(20,60, SmallEnemy10pointB, 16,10);
	Enemy1[7].x = 20;
	Enemy1[7].y = 60;
	ST7735_DrawBitmap(40, 60, SmallEnemy20pointA, 16,10);
	Enemy1[8].x = 40;
	Enemy1[8].y = 60;
	ST7735_DrawBitmap(60, 60, SmallEnemy20pointB, 16,10);
	Enemy1[9].x = 60;
	Enemy1[9].y = 60;
	ST7735_DrawBitmap(80, 60, SmallEnemy30pointA, 16,10);
	Enemy1[10].x = 80;
	Enemy1[10].y = 60;
  ST7735_DrawBitmap(100, 60, SmallEnemy30pointB, 16,10);
	Enemy1[11].x = 100;
	Enemy1[11].y = 60;
	
	
	
	 ST7735_SetCursor(0, 0);
	 ST7735_OutString("Score:");
	
  

  //Delay100ms(50);              // delay 5 sec at 80 MHz

	/*
  ST7735_FillScreen(0x0000);            // set screen to black
  ST7735_SetCursor(1, 1);
  ST7735_OutString("GAME OVER");
  ST7735_SetCursor(1, 2);
  ST7735_OutString("Nice try,");
  ST7735_SetCursor(1, 3);
  ST7735_OutString("Earthling!");
  ST7735_SetCursor(2, 4);
  LCD_OutDec(1234);
	*/
	
	
	//Timer1_Init(&LCD_FPS, 20000000);
	//Timer1_Init(&LCD_FPS, 2666677);
	Timer0_Init(&Enemy_Movement, 750000);
	
	//Timer3_Init(&Missile_Movement, 15000000);

 //Local Variables//
 uint32_t data;
 uint32_t old_position;
 uint32_t position;
 //uint8_t num_aliens = 6;

ST7735_FillScreen(0);
//*************//
	EnableInterrupts();	
	 while(1){
	//ST7735_FillScreen(0);
		 
		
		if(ADCstatus == fresh){
			
			data = ADCmail;
			ADCstatus = stale;
				
			
			position = Convert(data);
		
			}
		
		player1.x = position;
			
	
				

		for(k = 0; k<150; k++){
			if((Missile1[k].y <40) & (Missile1[k].y != -1) & (Missile1[k].y != 0)) {
				//DisableInterrupts();
				Missile1[k].y =  -1;
				Missile1[k].x = -1;
				//LCD_FPS();
				//EnableInterrupts();
				ST7735_FillScreen(0x0000); 
				}	
		}
	
					

			for(l = 0; l<150; l++){
				for(m = 0; m<num_aliens; m++){
					if(((Missile1[l].y -13) <  Enemy1[m].y)){
						if(((Missile1[l].y-13) > (Enemy1[m].y -10))){
							if((Missile1[l].x) > Enemy1[m].x & Missile1[l].x < (Enemy1[m].x + 16)){
								if(Missile1[l].x != -1 & Missile1[l].y != -1 & Enemy1[m].x != -1 & Enemy1[m].y != -1){
								//DisableInterrupts();
								Missile1[l].x = -1;
								Missile1[l].y = -1;
								Enemy1[m].x = -1;
								Enemy1[m].y = -1;
								DisableInterrupts();
								player1.score++;
								ST7735_FillScreen(0x0000); 
								//LCD_FPS();
								EnableInterrupts();
								Timer1_Init(&Sound_Killed, 7256);
							}
					}
					}
				}
			}
		}		
			
		for(l = 0; l<150; l++){
				if(((Enemy_Missile1[l].y) <  player1.y)){
						if(((Enemy_Missile1[l].y) > (player1.y -8))){
							if((Enemy_Missile1[l].x) > (player1.x+8) & Enemy_Missile1[l].x < (player1.x + 26)){
								if(Enemy_Missile1[l].x != -1 & Enemy_Missile1[l].y != -1){
								//DisableInterrupts();
								Enemy_Missile1[l].x = -1;
								Enemy_Missile1[l].y = -1;
								
								DisableInterrupts();
								player1.lives--;
								ST7735_FillScreen(0x0000); 
								if(player1.lives == 0){
									End_Screen();
								}
								//LCD_FPS();
								EnableInterrupts();
								Timer1_Init(&Sound_Explosion, 7256);
							}
					}
					}
				}
			
		}		
			
		for(o = 0; o<num_aliens; o++){
			if(Enemy1[o].y >150){
					lose_life = 1;
					Life_lost();
			}				
			
		}
	
		
		for(o = 0; o<num_aliens; o++){
			if(Enemy1[o].y == -1 & Enemy1[o].x == -1){
					increase_level++;
				if(increase_level == num_aliens){
						Increase_Level();
				}
				
			}		
										
		}
		increase_level = 0;
		
		
		if(player1.lives == 1){
			End_Screen();
		}
		
		if(player1.score == 36){
			End_Screen();
		}
	
	//Delay100ms(10);	
	static int32_t yposition = 9;
	static int32_t step = 1;
	static int32_t stepM = -1;
	//timer_flag++;
	//ST7735_FillScreen(0);
	
	//ST7735_FillScreen(0x0000); 
	
	ST7735_SetCursor(0, 0);
	ST7735_OutString("Score:");
	LCD_OutDec(player1.score);
	ST7735_SetCursor(10, 0);
	ST7735_OutString("Lives:");
	LCD_OutDec(player1.lives-1);
	
	
	DisableInterrupts();
	ST7735_DrawBitmap(player1.x, 159, PlayerShip0, 34,7);
	
	ST7735_DrawBitmap(Enemy1[0].x, Enemy1[0].y, SmallEnemy10pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[1].x,Enemy1[1].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[2].x, Enemy1[2].y, SmallEnemy20pointA, 16,10);
	ST7735_DrawBitmap(Enemy1[3].x, Enemy1[3].y, SmallEnemy20pointB, 16,10);
  ST7735_DrawBitmap(Enemy1[4].x, Enemy1[4].y, SmallEnemy30pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[5].x, Enemy1[5].y, SmallEnemy30pointB, 16,10);
	
  ST7735_DrawBitmap(Enemy1[6].x,Enemy1[6].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[7].x,Enemy1[7].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[8].x, Enemy1[8].y, SmallEnemy20pointA, 16,10);
	ST7735_DrawBitmap(Enemy1[9].x, Enemy1[9].y, SmallEnemy20pointB, 16,10);
  ST7735_DrawBitmap(Enemy1[10].x, Enemy1[10].y, SmallEnemy30pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[11].x, Enemy1[11].y, SmallEnemy30pointB, 16,10);
	
	
	
	if(total_missile>0){
		for(i = 0; i<150; i++){
			ST7735_DrawBitmap(Missile1[i].x, Missile1[i].y, missile, 6,14);
		}	
	}
		
	if(total_enemy_missile>0){
		for(i = 0; i<150; i++){
			ST7735_DrawBitmap(Enemy_Missile1[i].x, Enemy_Missile1[i].y, enemy_missile, 6,14);
		}	
		
	}
		
		
	
			
			EnableInterrupts();
	
	
		}
	
	}
	



	

//***********************************************************************//

// Converts ADC to Pixel position//
int32_t Convert(uint32_t input){
	
	
	  return (128*input)/(4096)-20;
	
	
	
}

//********************************************************

void StartScreen(void){
	
	 
  ST7735_FillScreen(0x0000);            // set screen to black
	ST7735_SetCursor(4, 7);
	ST7735_OutString("Space Invaders");
	ST7735_SetCursor(3, 10);
	ST7735_OutString("Single Player: b1");
	ST7735_SetCursor(3, 11);
	ST7735_OutString("Multi-Player:  b2");
	
	
	
  
	while(1){
	
		if(((GPIO_PORTF_DATA_R & 0x10) == 0x10)){
			
				
					Timer1_Init(&Sound_Fastinvader1, 7256);
				
			
			break;
		
		}
		
		if(((GPIO_PORTE_DATA_R & 0x01) == 1)){
			
		Timer1_Init(&Sound_Fastinvader1, 7256);
			
			Multi_Player();
		
		}
	
	
}	
	//Timer1_Init(&Sound_Fastinvader1, 7256);
	
}

void End_Screen(void){
	ST7735_FillScreen(0x0000);  
	ST7735_SetCursor(0, 0);
	ST7735_OutString("Score:");
	LCD_OutDec(player1.score);
	while(1){};
	
}

void Delay100ms(uint32_t count){uint32_t volatile time;
  while(count>0){
    //time = 727240;  // 0.1sec at 80 MHz
		time = 7000;
    while(time){
	  	time--;
    }
    count--;
  }
}


void Life_lost(void){
	player1.lives--;
	for(o = 0; o<(num_aliens/2); o++){
		if(Enemy1[o].y != -1 & Enemy1[o].x != -1){
		Enemy1[o].y = 40;
		}
	}
	for(o = (num_aliens/2); o<num_aliens; o++){
		if(Enemy1[o].x != -1 & Enemy1[o].y != -1){
		Enemy1[o].y = 60;
		}
		
	}
	lose_life = 0;
	Timer1_Init(&Sound_Explosion, 7256);
	ST7735_FillScreen(0x0000); 
	
	
}


void Increase_Level(void){
	for(o = 0; o<(num_aliens/2); o++){
		Enemy1[o].y = 40;
		Enemy1[o].x = o*20;
		}
	

	
	for(o = (num_aliens/2); o<num_aliens; o++){
		Enemy1[o].y = 60;
		Enemy1[o].x = (o-(num_aliens/2)) * 20;
		
	}
	level = level -5;
	//enemy_firing = enemy_firing -10;
	increase_level = 0;
	timer_flag = level-1;
	ST7735_FillScreen(0x0000); 
	
	
}


void Enemy_Fire(void){
	uint8_t random_num;
	static uint32_t g;
	enemy_flag++;
	
	if(enemy_flag == enemy_firing){
		enemy_flag = 0;
		Random_Init(ADCmail);
		random_num = Random()%11;
	
		total_enemy_missile++;
		if(total_enemy_missile < 151){
			Enemy_Missile1[g].x = Enemy1[random_num].x+5;
			Enemy_Missile1[g].y = Enemy1[random_num].y;
		
		}
		else{
			for(f = 0; f<150; k++){
				if(Enemy_Missile1[f].x == -1 & Enemy_Missile1[k].y == -1){
						Enemy_Missile1[f].x = Enemy1[random_num].x+5;
						Enemy_Missile1[f].y = Enemy1[random_num].y;
				
				}
			
			}
		
		
	
		
}  

		//num_missile++;
	g++;
	
}	
	
}





//*******************************************************************************//
//*******************************************************************************//
//*********************Interrupt Handlers and Tasks******************************//


void Enemy_Movement(void){
	static int32_t yposition = 9;
	static int32_t step = 1;
	static int32_t stepM = -1;
	static uint8_t timer_flag;
	uint8_t random_num;
	static uint32_t g;
	enemy_flag++;
	//firing_flag++;
	timer_flag++;
	
	//static uint8_t ypositionM = 151;
	
	
	if(timer_flag == level){
		timer_flag = 0;
		for(j = 0; j<12; j++){
			if(Enemy1[j].y != -1){
			
			Enemy1[j].y += step;
			
	
	}
			}
		}

	
	if(enemy_flag == enemy_firing){
		enemy_flag = 0;
		Random_Init(ADCmail);
		random_num = Random()%11;
	
		total_enemy_missile++;
		if(total_enemy_missile < 151){
			if((Enemy1[random_num].x != -1 & Enemy1[random_num].y != -1)){
			Enemy_Missile1[g].x = Enemy1[random_num].x+5;
			Enemy_Missile1[g].y = Enemy1[random_num].y;
			}
		}
		else{
			for(f = 0; f<150; f++){
				if(Enemy_Missile1[f].x == -1 & Enemy_Missile1[f].y == -1){
					if(Enemy1[random_num].x != -1 & Enemy1[random_num].y != -1){
						Enemy_Missile1[f].x = Enemy1[random_num].x+5;
						Enemy_Missile1[f].y = Enemy1[random_num].y;
					}
				}
			
			}
		
		
	
		
}  

		//num_missile++;
	g++;
	
}	
	
	if(total_missile > 0){
		for(j = 0; j<150; j++){
			if(Missile1[j].y != -1){
				
				Missile1[j].y +=stepM;
				
			}
		}
	}
	

		
	if(total_enemy_missile > 0){			
		for(j = 0; j<150; j++){
			if(Enemy_Missile1[j].y != -1 & Enemy_Missile1[j].y !=0){
				
				Enemy_Missile1[j].y +=step;
			
				
			}
		}
	
}

	
	
	//yposition += step;
	
	if(yposition == 200){
		gamestatus = 1;
		
	}
		
}	

void Missile_Movement(void){
	static int32_t stepM = -1;
	uint8_t z;
	if(num_missile > 0){
		for(z = 0; z<num_missile; z++){
			Missile1[j].y +=stepM;
			
		}
	}
	
	
}





void LCD_FPS(void){
	DisableInterrupts();
	static int32_t yposition = 9;
	static int32_t step = 1;
	static int32_t stepM = -1;
	timer_flag++;
	ST7735_FillScreen(0);
	
	//ST7735_FillScreen(0x0000); 
	/*
	ST7735_SetCursor(0, 0);
	ST7735_OutString("Score:");
	LCD_OutDec(player1.score);
	ST7735_SetCursor(10, 0);
	ST7735_OutString("Lives:");
	LCD_OutDec(player1.lives);
	*/
	
	
	ST7735_DrawBitmap(player1.x, 159, PlayerShip0, 18,8);
	ST7735_DrawBitmap(player2.x, 7, player2ship, 34,7);
	/*
	ST7735_DrawBitmap(Enemy1[0].x, Enemy1[0].y, SmallEnemy10pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[1].x,Enemy1[1].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[2].x, Enemy1[2].y, SmallEnemy20pointA, 16,10);
	ST7735_DrawBitmap(Enemy1[3].x, Enemy1[3].y, SmallEnemy20pointB, 16,10);
  ST7735_DrawBitmap(Enemy1[4].x, Enemy1[4].y, SmallEnemy30pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[5].x, Enemy1[5].y, SmallEnemy30pointB, 16,10);
	
  ST7735_DrawBitmap(Enemy1[6].x,Enemy1[6].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[7].x,Enemy1[7].y, SmallEnemy10pointB, 16,10);
	ST7735_DrawBitmap(Enemy1[8].x, Enemy1[8].y, SmallEnemy20pointA, 16,10);
	ST7735_DrawBitmap(Enemy1[9].x, Enemy1[9].y, SmallEnemy20pointB, 16,10);
  ST7735_DrawBitmap(Enemy1[10].x, Enemy1[10].y, SmallEnemy30pointA, 16,10);
  ST7735_DrawBitmap(Enemy1[11].x, Enemy1[11].y, SmallEnemy30pointB, 16,10);
	*/
	
	
	if(total_missile>0){
		for(i = 0; i<150; i++){
			if(Missile1[i].x != -1 & Missile1[i].x != -1){
			ST7735_DrawBitmap(Missile1[i].x, Missile1[i].y, missile, 4,13);
		}	
	}
		
	//}
			}
	
	if(total_enemy_missile>0){
		for(i = 0; i<150; i++){
			if(Enemy_Missile1[i].x != 0 & Enemy_Missile1[i].y != 0){
			ST7735_DrawBitmap(Enemy_Missile1[i].x, Enemy_Missile1[i].y, enemy_missile, 6,14);
			}
		}	
		
	}
			
			EnableInterrupts();
		}
		
	



void SysTick_Handler(void){

	ADCmail = ADC_In();
	ADCstatus = fresh;
	

	
}


void GPIOPortF_Handler(void){
  GPIO_PORTF_ICR_R = 0x10;// acknowledge flag4
  //isshot = fresh;
	uint8_t k;
	static uint16_t w;
	static uint8_t status;
	static uint32_t count = 1;
	
	
	if(count == 1){
	//Timer1_Init(&Sound_Shoot, 7256);
		count = 0;
		
		
	}	
	else Timer1_Init(&Sound_Shoot, 7256);
	//static uint16_t v;
	//num_missile++;
//	Sound_Play();
	/*
	if(num_missile != 0){
		for(k = 0; k<num_missile; k++){
			//if(Missile1[k].y == -1 & Missile1[k].x == -1){
				StartCritical();
				Missile1[k].x = player1.x+20;
				Missile1[k].y = player1.y+10;
				EndCritical();
				//v++;
				
				
				//}
			}
		}
	
	
	else  {
			Missile1[num_missile].x = player1.x+20;
			Missile1[num_missile].y = player1.y-10;
			//num_missile++;
			
		}
	
		
	num_missile = 0;
 
	for(k = 0; k<10; k++){
		if(Missile1[k].x != -1 & Missile1[k].x !=0){
			if(Missile1[k].y != -1 & Missile1[k].y !=0){
					num_missile++;
		}		
	}
}
*/

	

	
	
	
	 status = fresh;
		for(k = 0; k<150; k++){
		  if((player1.y-10) - Missile1[k].y < 5){
				status = stale;
				break;
		}
			
	}
	if(status ==fresh){
	if(Enemy1[0].y !=	40){
	total_missile++;
	if(total_missile < 151){
		Missile1[w].x = player1.x+20;
		Missile1[w].y = player1.y-10;
		
	}
	else{
		for(k = 0; k<150; k++){
			if(Missile1[k].x == -1 & Missile1[k].y == -1){
					Missile1[k].x = player1.x+20;
					Missile1[k].y = player1.y-10;
				
			}
			
		}
		
		
	
		
}  

		//num_missile++;
	w++;

}
	}
	
}



void Multi_Player(void){
	FiFo_Init();
	UART_Init();
	char data;
	uint32_t data2;
	long temp;
	char watch;
	uint8_t i = 0;
	uint8_t button_flag, button_flag2;
	uint32_t g,q;
	//uint32_t sum;
	//int8_t stepM = -1;
	uint32_t player2_position;
	uint32_t player1_position;
	ST7735_FillScreen(0x0000); 
	//Timer1_Init(&Sound_Fastinvader1, 7256);
	
	
	Timer0_Init(&Multiplayer_Movement, 750000);
	//Timer1_Init(&LCD_FPS, 20000000);
	player1.y = 159;
	player2.y = 7;
	player1.lives = 4;
	player2.lives = 4;
	

	
	while(1){
		
		while( FiFo_Get(&data) == 0){}		//waits for FiFo to have data		ST7735_SetCursor(1,0);
		

		while( data != 0x02){
			
		FiFo_Get(&data);
		}; //ignores start bit
		
		
		
		//FiFo_Get(&data);
		sum = 0;
		
		FiFo_Get(&data);	
		data = data - 0x30;
		temp = data * 1000;
		sum += temp;
		
		FiFo_Get(&data);	
		data = data - 0x30;
		temp = data* 100;
		sum += temp;
		
			
		FiFo_Get(&data);	
		data = data - 0x30;
		temp = data * 10;
		sum += temp;
		
		
		FiFo_Get(&data);	
		data = data - 0x30;
		temp = data*1;
		sum += temp;
		

			
		FiFo_Get(&data);	
		FiFo_Get(&data);	
		FiFo_Get(&data);
		
		
			
		player2_position = Convert(sum);
		
			
		
		if(ADCstatus == fresh){
			
			data2 = ADCmail;
			ADCstatus = stale;
				
			player1_position = Convert(data2);
		
			}
			
		
			player1.x = player1_position;
			player2.x = player2_position;
			//player2.x = sum;
			
		if((GPIO_PORTE_DATA_R & 0x01) == 0){
			button_flag = 1;
			
		}
		
		if(((GPIO_PORTE_DATA_R & 0x01) == 0x01) & (button_flag == 1)){
			button_flag = 0;
				total_enemy_missile++;
			if(total_enemy_missile < 151){

				Enemy_Missile1[g].x = player2.x+14;
				Enemy_Missile1[g].y = player2.y;
			
		}
			else{
				for(f = 0; f<150; f++){
					if(Enemy_Missile1[f].x == -1 & Enemy_Missile1[f].y == -1){
						
							Enemy_Missile1[f].x = player2.x+6;
							Enemy_Missile1[f].y = player2.y;
					
				}
			
			}
		
		
	
		
}  

		//num_missile++;
	g++;
			
			
			
		
			
			
}
		
		
			if((GPIO_PORTF_DATA_R & 0x10) == 0){
			button_flag2 = 1;
			
		}
			
		if(((GPIO_PORTE_DATA_R & 0x10) == 0x10) & (button_flag2 == 1)){
			button_flag2 = 0;
			total_missile++;
			if(total_missile < 151){

				Missile1[q].x = player1.x+14;
				Missile1[q].y = player1.y;
			
		}
			else{
				for(f = 0; f<150; f++){
					if(Missile1[f].x == -1 & Missile1[f].y == -1){
						
						Missile1[f].x = player1.x+6;
						Missile1[f].y = player1.y;
					
				}
			
			}
		
		
	
		
}  

		//num_missile++;
	q++;
			
			
			
		
			
			
		}
		
		
		
		

	
		
		
		for(l = 0; l<150; l++){
				if(((Enemy_Missile1[l].y) <  player1.y)){
						if(((Enemy_Missile1[l].y) > (player1.y -8))){
							if((Enemy_Missile1[l].x) > (player1.x+8) & Enemy_Missile1[l].x < (player1.x + 26)){
								if(Enemy_Missile1[l].x != -1 & Enemy_Missile1[l].y != -1){
								//DisableInterrupts();
								Enemy_Missile1[l].x = -1;
								Enemy_Missile1[l].y = -1;
								
								DisableInterrupts();
								player1.lives--;
								ST7735_FillScreen(0x0000); 
							
								//LCD_FPS();
								EnableInterrupts();
								Timer1_Init(&Sound_Explosion, 7256);
							}
					}
					}
				}
			
		}		
		
		
		
		for(l = 0; l<150; l++){
					if(((Missile1[l].y -13) <  player2.y)){
						if(((Missile1[l].y-13) > (player2.y -7))){
							if((Missile1[l].x) > (player2.x+8) & Missile1[l].x < (player2.x + 26)){
								if(Missile1[l].x != -1 & Missile1[l].y != -1){
								//DisableInterrupts();
								Missile1[l].x = -1;
								Missile1[l].y = -1;
								player2.lives--;
								DisableInterrupts();
								
								ST7735_FillScreen(0x0000); 
								//LCD_FPS();
								EnableInterrupts();
								//Timer1_Init(&Sound_Killed, 7256);
							}
					}
					}
				}
			
		}		
		
		if(player1.lives == 3 | player2.lives ==3){
			End_Screen_Multi();
			
		
		}
		

		
			
			
			
		ST7735_DrawBitmap(player2.x, 7, player2ship, 34,7);
		ST7735_DrawBitmap(player1.x, 159, PlayerShip0, 34,7);
		
	if(total_enemy_missile>0){
		for(i = 0; i<150; i++){
			if(Enemy_Missile1[i].x != 0 & Enemy_Missile1[i].y != 0){
			ST7735_DrawBitmap(Enemy_Missile1[i].x, Enemy_Missile1[i].y, enemy_missile, 6,14);
			}
		}	
		
	}
	
	if(total_missile>0){
		for(i = 0; i<150; i++){
			if(Missile1[i].x != 0 & Missile1[i].y != 0){
			ST7735_DrawBitmap(Missile1[i].x, Missile1[i].y, enemy_missile, 6,14);
			}
		}	
		
	}
			
		
			
		

		
	}
}


uint32_t Convert_Multi(uint32_t input){
	

	
	  return (128*input)/(4096)-20;
	
	
}


void Multiplayer_Movement(void){
	uint8_t step = 1;
	int8_t stepM = -1;
	
		if(total_enemy_missile > 0){			
		for(j = 0; j<150; j++){
			if(Enemy_Missile1[j].y != -1){
				
				Enemy_Missile1[j].y +=step;
				
			}
		}
	
}
	
	if(total_missile > 0){			
		for(j = 0; j<150; j++){
			if(Missile1[j].y != -1){
				
				Missile1[j].y += stepM;
				
			}
		}

}

	
	
}

void End_Screen_Multi(void){
	ST7735_FillScreen(0x0000);  
	ST7735_SetCursor(0, 0);
	
	if(player1.lives > player2.lives){
		ST7735_OutString("Player1 Wins");
	}
	if(player1.lives < player2.lives){
		ST7735_OutString("Player2 Wins");
	}
	while(1){};
	
}
